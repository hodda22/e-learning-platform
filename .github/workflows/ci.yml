name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  backend:
    name: Backend checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install + test + build (backend)
        run: |
          if [ ! -f backend/package.json ]; then
            echo "No backend/package.json found — skipping backend."
            exit 0
          fi

          cd backend

          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

          npm test --if-present
          npm run build --if-present

          # Optional smoke test if server.js exists
          if [ -f server.js ]; then
            echo "Running backend smoke test..."
            node server.js &
            PID=$!
            sleep 2
            curl -f http://localhost:4000/api/courses
            kill $PID
          fi

  frontend:
    name: Frontend checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install + test + build (frontend)
        run: |
          if [ ! -f frontend/package.json ]; then
            echo "No frontend/package.json found — skipping frontend."
            exit 0
          fi

          cd frontend

          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

          npm test --if-present
          npm run build --if-present

